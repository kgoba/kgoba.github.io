<!DOCTYPE html>
<html lang="en">
<head>
	<title>Meteosonde tracker by YL3JG</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="js/paho-mqtt-min.js" type="text/javascript"></script>

	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 400px;
			width: 600px;
			max-width: 100%;
			max-height: 100%;
		}
	</style>

	<style>body { padding: 0; margin: 0; } #map { height: 100%; width: 100vw; }</style>
</head>

<body>
    <div id='map'></div>
    <script src="js/tracker.js" type="text/javascript"></script>
    <script>
        const mapCenter = [57.00, 24.00];
        const mapRadiusKm = 500;

        function inRange(point) {
            // return (Math.abs(point[0] - mapCenter[1]) < 20) && (Math.abs(point[1] - mapCenter[0]) < 14);
            return map.distance(mapCenter, [point.lat, point.lon]) < (mapRadiusKm * 1000);
        }

        var map = L.map('map', {closePopupOnClick: false});
        map.setView(mapCenter, 6);
        // map.fitWorld();

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 'https://api.mapbox.com/styles/v1/{username}/{style_id}/tiles/{tilesize}/{z}/{x}/{y}{@2x}'
        // L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        //     attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        //     maxZoom: 18,
        //     id: 'mapbox/outdoors-v11',
        //     tileSize: 512,
        //     zoomOffset: -1,
        //     accessToken: 'pk.eyJ1Ijoia2FybGlzZ28iLCJhIjoiY2wxa251aHg3MDJtZjNwbzZ5bXhieDAxOSJ9.CMjr3LPyI_fWDrR07tJe5Q'
        // }).addTo(map);

        // L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        //     maxZoom: 18,
        //     attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
        //         'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        //     id: 'mapbox/streets-v11',
        //     tileSize: 512,
        //     zoomOffset: -1
        // }).addTo(map);

        // Move the default location of zoom control
        map.zoomControl.setPosition('bottomright');

        // Adding range circle to the map
        L.circle(mapCenter, mapRadiusKm*1000, {fill: false}).addTo(map);

        // Add scale control to the map
        L.control.scale().addTo(map);

        function onLocationFound(e) {
            var radius = e.accuracy / 2;

            // var locationMarker = L.marker(e.latlng).addTo(map)
            //     .bindPopup('You are within ' + radius + ' meters from this point').openPopup();

            var locationCircle = L.circle(e.latlng, radius).addTo(map);
        }

        function onLocationError(e) {
            alert(e.message);
        }

        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);
        // map.locate({setView: true, maxZoom: 8});

        fetchListeners(function(name, loc) {
            let marker = L.circleMarker([loc.lat, loc.lon], { radius: 6, fillColor: '#008000', fillOpacity: 0.6, color: '#000000', weight: 1 });
            marker.bindTooltip(name);
            marker.addTo(map);
        });

        fetchSites(function(name, loc) {
            let marker = L.circleMarker([loc.lat, loc.lon], { radius: 7, fill: false, color: '#000000', weight: 3 });
            marker.bindTooltip(name);
            marker.addTo(map);
        });

        let ui = {
            addSonde: function(data) {
                let marker = L.circleMarker([data.loc.lat, data.loc.lon], { radius: 9, fillColor: '#FF0000', fillOpacity: 0.6, color: '#000000', weight: 1 });
                marker.addTo(map);
                // marker.bindPopup(name).openPopup();
                marker.bindTooltip(data.serial); // .openTooltip();
                return marker;
            },
            updateSonde: function(marker, data) {
                marker.setLatLng([data.loc.lat, data.loc.lon]);
                let content = '<b>' + data.serial + '</b><br/>Alt: ' + data.loc.alt.toFixed(0) + 'm';
                if (data.hasOwnProperty('vel_v')) {
                    content += '<br/>v_v: ' + data.vel_v.toFixed(1) + 'm/s';
                }
                if (data.hasOwnProperty('vel_h')) {
                    content += '<br/>v_h: ' + data.vel_h.toFixed(1) + 'm/s';
                }
                marker.bindPopup(content);
                // marker.setPopupContent(loc.alt.toFixed(0) + 'm');
                // marker.setTooltipContent(loc.alt.toFixed(0) + 'm');
            },
            addPath: function(pointList) {
                let path = L.polyline(pointList.map(x => [x.lat, x.lon]), {color: '#FF0000', opacity: 0.6})
                path.addTo(map);
                return path;
            },
            updatePath: function(path, loc) {
                path.addLatLng([loc.lat, loc.lon]);
            },
        }
        fetchSondes(ui, mapRadiusKm);
    </script>
</body>
</html>
